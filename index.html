<!DOCTYPE html>
<html>
<head>
<title>Proximity Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  background:#0f0f0f;
  color:white;
  font-family:Arial, sans-serif;
  margin:0;
  padding:20px;
}

h1{text-align:center}

#login{
  max-width:420px;
  margin:40px auto;
  background:#1a1a1a;
  padding:22px;
  border-radius:16px;
  text-align:center;
}

input{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:8px;
  background:#333;
  color:white;
}

button{
  width:100%;
  padding:14px;
  margin-top:15px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}

#joinBtn{background:#4caf50}

#muteBtn{
  max-width:300px;
  margin:20px auto;
  display:none;
  background:#e53935;
}

.dimensions{
  gap:20px;
  max-width:1200px;
  margin:30px auto;
  flex-direction:column;
}

@media(min-width:900px){
  .dimensions{flex-direction:row}
}

.dimension{
  flex:1;
  padding:20px;
  border-radius:18px;
}

.overworld{background:#1f6f5f}
.nether{background:#7a1f1f}
.end{background:#4b2a6f}

.dimension button{
  background:white;
  color:black;
  margin-top:10px;
}

#players{
  max-width:520px;
  margin:30px auto;
  background:#1a1a1a;
  padding:16px;
  border-radius:14px;
  text-align:center;
}

.player{
  background:#2a2a2a;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
}
</style>
</head>

<body>

<h1>Proximity Chat</h1>

<div id="login">
  <input id="usernameInput" placeholder="Minecraft Username">
  <input id="passwordInput" type="password" placeholder="Room password">
  <button id="joinBtn">Join Server</button>
</div>

<button id="muteBtn">Mute Mic</button>

<!-- ðŸ”’ REALLY HIDDEN -->
<div class="dimensions" id="dimensions" hidden>
  <div class="dimension overworld">
    <h2>Overworld</h2>
    <button onclick="joinGroup('Overworld',1)">Group 1</button>
    <button onclick="joinGroup('Overworld',2)">Group 2</button>
    <button onclick="joinGroup('Overworld',3)">Group 3</button>
  </div>

  <div class="dimension nether">
    <h2>Nether</h2>
    <button onclick="joinGroup('Nether',1)">Group 1</button>
    <button onclick="joinGroup('Nether',2)">Group 2</button>
    <button onclick="joinGroup('Nether',3)">Group 3</button>
  </div>

  <div class="dimension end">
    <h2>End</h2>
    <button onclick="joinGroup('End',1)">Group 1</button>
    <button onclick="joinGroup('End',2)">Group 2</button>
    <button onclick="joinGroup('End',3)">Group 3</button>
  </div>
</div>

<div id="players">
  <strong>Players in group</strong>
  <div id="playerList">Not in a group</div>
</div>

<script>
const ROOM_PASSWORD="BMS Minecraft";

firebase.initializeApp({
  apiKey:"AIzaSyCR0kIMG1QJzWMUh52UYduYoL9a-f_Db-w",
  authDomain:"proximity-chat-95107.firebaseapp.com",
  databaseURL:"https://proximity-chat-95107-default-rtdb.firebaseio.com",
  projectId:"proximity-chat-95107"
});

const db=firebase.database();

let username="";
let currentPath="";
let listener=null;

let micStream;
let audioCtx;
let micSource;
let silentGain;
let isMuted=false;

joinBtn.onclick=async()=>{
  if(passwordInput.value!==ROOM_PASSWORD){
    alert("Wrong password");
    return;
  }

  username=usernameInput.value.trim();
  if(!username){
    alert("Enter username");
    return;
  }

  try{
    micStream=await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx=new AudioContext();
    micSource=audioCtx.createMediaStreamSource(micStream);
    silentGain=audioCtx.createGain();
    silentGain.gain.value=1;
    micSource.connect(silentGain).connect(audioCtx.destination);
  }catch{
    alert("Mic permission denied");
    return;
  }

  login.hidden=true;
  dimensions.hidden=false;
  dimensions.style.display="flex"; // ONLY HERE
  muteBtn.style.display="block";
};

muteBtn.onclick=()=>{
  if(!micStream) return;
  isMuted=!isMuted;
  silentGain.gain.value=isMuted?0:1;
  muteBtn.textContent=isMuted?"Unmute Mic":"Mute Mic";
  muteBtn.style.background=isMuted?"#4caf50":"#e53935";
};

function leaveGroup(){
  if(!currentPath) return;
  db.ref(currentPath+"/"+username).remove();
  if(listener) db.ref(currentPath).off("value",listener);
  playerList.textContent="Not in a group";
}

function joinGroup(dim,group){
  leaveGroup();
  currentPath=`groups/${dim}/${group}`;
  const me=db.ref(currentPath+"/"+username);
  me.set(true);
  me.onDisconnect().remove();

  listener=db.ref(currentPath).on("value",snap=>{
    const data=snap.val()||{};
    playerList.innerHTML="";
    Object.keys(data).forEach(name=>{
      const div=document.createElement("div");
      div.className="player";
      div.textContent=name+(name===username?" (You)":"");
      playerList.appendChild(div);
    });
  });
}
</script>

</body>
</html>
