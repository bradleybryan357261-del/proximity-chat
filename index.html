<!DOCTYPE html>
<html>
<head>
<title>Proximity Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

<style>
body{background:#121212;color:white;font-family:Arial;margin:0;padding:20px}
h1,h2{text-align:center}

.card{max-width:400px;margin:20px auto;background:#1a1a1a;padding:15px;border-radius:12px;text-align:center}
input{width:100%;padding:12px;margin-top:10px;border-radius:8px;border:none;background:#333;color:white}
button{width:100%;padding:14px;margin:10px 0;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
button:active{transform:scale(.96)}
#joinBtn{background:#4caf50}
#muteBtn{display:none;background:#e91e63;max-width:200px;margin:10px auto}

.dimensions{display:none;flex-direction:column;gap:20px;max-width:1200px;margin:20px auto}
@media(min-width:800px){.dimensions{flex-direction:row}}
.dimension{flex:1;padding:15px;border-radius:12px}
.overworld{background:#1f6f5f}
.nether{background:#7a1f1f}
.end{background:#4b2a6f}

#status,#players{display:none;max-width:600px;margin:15px auto;background:#1a1a1a;padding:12px;border-radius:10px;text-align:center}

.player{background:#2a2a2a;padding:10px;margin:8px 0;border-radius:8px;border:2px solid transparent}
.talking{border-color:#4caf50;box-shadow:0 0 12px #4caf50}
</style>
</head>

<body>

<h1>Proximity Chat</h1>

<div class="card" id="login">
  <input id="usernameInput" placeholder="Minecraft Username">
  <input id="roomCodeInput" type="password" placeholder="Room password">
  <button id="joinBtn">Join</button>
</div>

<button id="muteBtn">Mute Mic</button>

<div class="dimensions" id="dimensions">
  <div class="dimension overworld">
    <h2>Overworld</h2>
    <button onclick="join('Overworld',1)">Group 1</button>
    <button onclick="join('Overworld',2)">Group 2</button>
    <button onclick="join('Overworld',3)">Group 3</button>
  </div>
  <div class="dimension nether">
    <h2>Nether</h2>
    <button onclick="join('Nether',1)">Group 1</button>
    <button onclick="join('Nether',2)">Group 2</button>
    <button onclick="join('Nether',3)">Group 3</button>
  </div>
  <div class="dimension end">
    <h2>End</h2>
    <button onclick="join('End',1)">Group 1</button>
    <button onclick="join('End',2)">Group 2</button>
    <button onclick="join('End',3)">Group 3</button>
  </div>
</div>

<div id="status"></div>

<div id="players">
  <strong>Players in group</strong>
  <div id="playerList"></div>
</div>

<script>
const ROOM="BMS Minecraft";

firebase.initializeApp({
  apiKey:"AIzaSyCR0kIMG1QJzWMUh52UYduYoL9a-f_Db-w",
  authDomain:"proximity-chat-95107.firebaseapp.com",
  databaseURL:"https://proximity-chat-95107-default-rtdb.firebaseio.com",
  projectId:"proximity-chat-95107"
});

const db=firebase.database();

let username="", path="", peer, stream, calls={}, muted=false;
let analyser, data;

joinBtn.onclick=async()=>{
  if(roomCodeInput.value!==ROOM) return alert("Wrong password");
  username=usernameInput.value.trim();
  if(!username) return alert("Enter username");

  stream=await navigator.mediaDevices.getUserMedia({audio:true});
  peer=new Peer();

  setupTalkingDetector(stream);

  peer.on("open",()=>{
    login.style.display="none";
    dimensions.style.display="flex";
    players.style.display="block";
    status.style.display="block";
    muteBtn.style.display="block";
  });

  peer.on("call",c=>{
    c.answer(stream);
    c.on("stream",s=>playAudio(s,c.peer));
  });
};

muteBtn.onclick=()=>{
  muted=!muted;
  stream.getAudioTracks()[0].enabled=!muted;
  muteBtn.textContent=muted?"Unmute Mic":"Mute Mic";
};

function join(d,g){
  if(path){
    db.ref(path+"/"+username).remove();
    Object.values(calls).forEach(c=>c.close());
    calls={};
    document.querySelectorAll("audio").forEach(a=>a.remove());
  }

  path=`groups/${d}/${g}`;
  status.textContent=`Joined ${d} Group ${g}`;

  const me=db.ref(path+"/"+username);
  me.set({peerId:peer.id,isTalking:false});
  me.onDisconnect().remove();

  db.ref(path).on("value",snap=>{
    playerList.innerHTML="";
    const all=snap.val()||{};
    for(const name in all){
      const div=document.createElement("div");
      div.className="player"+(all[name].isTalking?" talking":"");
      div.textContent=name+(name===username?" (You)":"");
      playerList.appendChild(div);

      if(name!==username && all[name].peerId && !calls[name]){
        const call=peer.call(all[name].peerId,stream);
        calls[name]=call;
        call.on("stream",s=>playAudio(s,all[name].peerId));
      }
    }
  });
}

function playAudio(s,id){
  if(document.getElementById("a"+id))return;
  const a=document.createElement("audio");
  a.id="a"+id;
  a.srcObject=s;
  a.autoplay=true;
  document.body.appendChild(a);
}

function setupTalkingDetector(stream){
  const ctx=new AudioContext();
  analyser=ctx.createAnalyser();
  analyser.fftSize=512;
  const src=ctx.createMediaStreamSource(stream);
  src.connect(analyser);
  data=new Uint8Array(analyser.frequencyBinCount);
  monitor();
}

function monitor(){
  if(!path)return;
  analyser.getByteFrequencyData(data);
  const avg=data.reduce((a,b)=>a+b)/data.length;
  const talking=avg>20 && !muted;
  db.ref(path+"/"+username+"/isTalking").set(talking);
  requestAnimationFrame(monitor);
}
</script>

</body>
</html>
