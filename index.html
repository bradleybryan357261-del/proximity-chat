<!DOCTYPE html>
<html>
<head>
<title>Proximity Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
  background:#121212;
  color:white;
  font-family:Arial;
  margin:0;
  padding:20px
}

h1,h2{text-align:center}

.card{
  max-width:400px;
  margin:20px auto;
  background:#1a1a1a;
  padding:15px;
  border-radius:12px;
  text-align:center
}

input{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
  background:#333;
  color:white
}

button{
  width:100%;
  padding:14px;
  margin:10px 0;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer
}

button:active{transform:scale(.96)}

#joinBtn{background:#4caf50}

.dimensions{
  display:none;
  flex-direction:column;
  gap:20px;
  max-width:1200px;
  margin:20px auto
}

@media(min-width:800px){
  .dimensions{flex-direction:row}
}

.dimension{
  flex:1;
  padding:15px;
  border-radius:12px
}

.overworld{background:#1f6f5f}
.nether{background:#7a1f1f}
.end{background:#4b2a6f}

#status{
  max-width:600px;
  margin:15px auto;
  background:#1a1a1a;
  padding:12px;
  border-radius:10px;
  text-align:center;
  display:none
}

#players{
  max-width:600px;
  margin:15px auto;
  background:#1a1a1a;
  padding:12px;
  border-radius:10px;
  text-align:center;
  /* IMPORTANT: NEVER HIDDEN */
}

.player{
  background:#2a2a2a;
  padding:10px;
  margin:8px 0;
  border-radius:8px
}
</style>
</head>

<body>

<h1>Proximity Chat</h1>

<div class="card" id="login">
  <input id="usernameInput" placeholder="Minecraft Username">
  <input id="roomCodeInput" type="password" placeholder="Room password">
  <button id="joinBtn">Join</button>
</div>

<div class="dimensions" id="dimensions">
  <div class="dimension overworld">
    <h2>Overworld</h2>
    <button onclick="joinGroup('Overworld',1)">Group 1</button>
    <button onclick="joinGroup('Overworld',2)">Group 2</button>
    <button onclick="joinGroup('Overworld',3)">Group 3</button>
  </div>

  <div class="dimension nether">
    <h2>Nether</h2>
    <button onclick="joinGroup('Nether',1)">Group 1</button>
    <button onclick="joinGroup('Nether',2)">Group 2</button>
    <button onclick="joinGroup('Nether',3)">Group 3</button>
  </div>

  <div class="dimension end">
    <h2>End</h2>
    <button onclick="joinGroup('End',1)">Group 1</button>
    <button onclick="joinGroup('End',2)">Group 2</button>
    <button onclick="joinGroup('End',3)">Group 3</button>
  </div>
</div>

<div id="status"></div>

<div id="players">
  <strong>Players in group</strong>
  <div id="playerList">
    <em>Join a group to see players</em>
  </div>
</div>

<script>
const ROOM="BMS Minecraft";

firebase.initializeApp({
  apiKey:"AIzaSyCR0kIMG1QJzWMUh52UYduYoL9a-f_Db-w",
  authDomain:"proximity-chat-95107.firebaseapp.com",
  databaseURL:"https://proximity-chat-95107-default-rtdb.firebaseio.com",
  projectId:"proximity-chat-95107"
});

const db=firebase.database();

let username="";
let path="";
let listener=null;

joinBtn.onclick=()=>{
  if(roomCodeInput.value!==ROOM){
    alert("Wrong password");
    return;
  }

  username=usernameInput.value.trim();
  if(!username){
    alert("Enter username");
    return;
  }

  login.style.display="none";
  dimensions.style.display="flex";
  status.style.display="block";
};

function leaveGroup(){
  if(!path) return;

  db.ref(path+"/"+username).remove();
  if(listener) db.ref(path).off("value",listener);
  path="";
  playerList.innerHTML="<em>Join a group to see players</em>";
}

function joinGroup(d,g){
  leaveGroup();

  path=`groups/${d}/${g}`;
  status.textContent=`Joined ${d} Group ${g}`;

  const me=db.ref(path+"/"+username);
  me.set(true);
  me.onDisconnect().remove();

  // ALWAYS show yourself immediately
  playerList.innerHTML="";
  const self=document.createElement("div");
  self.className="player";
  self.textContent=username+" (You)";
  playerList.appendChild(self);

  listener=db.ref(path).on("value",snap=>{
    playerList.innerHTML="";
    const all=snap.val()||{};
    Object.keys(all).forEach(name=>{
      const div=document.createElement("div");
      div.className="player";
      div.textContent=name+(name===username?" (You)":"");
      playerList.appendChild(div);
    });
  });
}
</script>

</body>
</html>
