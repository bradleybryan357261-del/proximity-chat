<!DOCTYPE html>
<html>
<head>
  <title>Proximity Chat</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body {
      background: #121212;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    h1 { text-align: center; }

    .card {
      max-width: 400px;
      margin: 20px auto;
      background: #1a1a1a;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
    }

    input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      margin-top: 10px;
      font-size: 16px;
    }

    button {
      width: 100%;
      padding: 14px;
      margin-top: 15px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

    button:active {
      transform: scale(0.96);
    }

    .dimensions {
      display: none;
      flex-direction: column;
      gap: 20px;
      max-width: 1200px;
      margin: 20px auto;
    }

    @media (min-width: 800px) {
      .dimensions { flex-direction: row; }
    }

    .dimension {
      flex: 1;
      padding: 15px;
      border-radius: 12px;
    }

    .overworld { background: #1f6f5f; }
    .nether { background: #7a1f1f; }
    .end { background: #4b2a6f; }

    #status, #players {
      display: none;
      max-width: 600px;
      margin: 15px auto;
      background: #1a1a1a;
      padding: 12px;
      border-radius: 10px;
      text-align: center;
    }

    .player {
      padding: 10px;
      border-radius: 8px;
      margin: 8px 0;
      background: #2a2a2a;
      transition: box-shadow 0.1s, background 0.1s;
    }

    .talking {
      background: #1b5e20;
      box-shadow: 0 0 15px #4caf50;
    }
  </style>
</head>

<body>

<h1>Proximity Chat</h1>

<div class="card" id="login">
  <p>Minecraft Username</p>
  <input id="usernameInput" placeholder="Username" autocapitalize="none">

  <p style="margin-top:10px;">Room Password</p>
  <input id="roomCodeInput" placeholder="Room password" autocapitalize="none">

  <button id="joinBtn">Join</button>
</div>

<div class="dimensions" id="dimensions">
  <div class="dimension overworld">
    <h2>Overworld</h2>
    <button data-d="Overworld" data-g="1">Group 1</button>
    <button data-d="Overworld" data-g="2">Group 2</button>
    <button data-d="Overworld" data-g="3">Group 3</button>
  </div>

  <div class="dimension nether">
    <h2>Nether</h2>
    <button data-d="Nether" data-g="1">Group 1</button>
    <button data-d="Nether" data-g="2">Group 2</button>
    <button data-d="Nether" data-g="3">Group 3</button>
  </div>

  <div class="dimension end">
    <h2>End</h2>
    <button data-d="End" data-g="1">Group 1</button>
    <button data-d="End" data-g="2">Group 2</button>
    <button data-d="End" data-g="3">Group 3</button>
  </div>
</div>

<div id="status"></div>

<div id="players">
  <strong>Players in group</strong>
  <div id="playerList"></div>
</div>

<script>
  const ROOM_CODE = "BMS Minecraft";

  const firebaseConfig = {
    apiKey: "AIzaSyCR0kIMG1QJzWMUh52UYduYoL9a-f_Db-w",
    authDomain: "proximity-chat-95107.firebaseapp.com",
    databaseURL: "https://proximity-chat-95107-default-rtdb.firebaseio.com",
    projectId: "proximity-chat-95107",
    storageBucket: "proximity-chat-95107.firebasestorage.app",
    messagingSenderId: "347116592936",
    appId: "1:347116592936:web:4eb61da00f475c73a3fa1d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let username = "";
  let currentPath = "";

  document.getElementById("joinBtn").onclick = () => {
    const name = usernameInput.value.trim();
    const code = roomCodeInput.value.trim();

    if (code !== ROOM_CODE) return alert("Wrong room password");
    if (!/^[a-zA-Z0-9_]{3,16}$/.test(name)) return alert("Invalid username");

    username = name;
    login.style.display = "none";
    dimensions.style.display = "flex";
    status.style.display = "block";
    players.style.display = "block";
  };

  document.querySelectorAll("button[data-d]").forEach(btn => {
    btn.onclick = () => {
      if (currentPath) db.ref(currentPath + "/" + username).remove();

      currentPath = `groups/${btn.dataset.d}/${btn.dataset.g}`;
      const ref = db.ref(currentPath + "/" + username);

      ref.set(true);
      ref.onDisconnect().remove();

      status.textContent = `Connected to ${btn.dataset.d} â€“ Group ${btn.dataset.g}`;

      db.ref(currentPath).on("value", snap => {
        playerList.innerHTML = "";
        const players = snap.val() || {};
        Object.keys(players).forEach(name => {
          const div = document.createElement("div");
          div.className = "player";
          div.textContent = name;
          playerList.appendChild(div);
        });
      });
    };
  });

  // ðŸŽ¤ FULL SENSITIVITY MIC + TALKING GLOW
  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
    const ctx = new AudioContext();
    const analyser = ctx.createAnalyser();
    analyser.fftSize = 512;

    const mic = ctx.createMediaStreamSource(stream);
    mic.connect(analyser);

    const data = new Uint8Array(analyser.frequencyBinCount);

    function loop() {
      analyser.getByteFrequencyData(data);
      const volume = data.reduce((a, b) => a + b) / data.length;

      const talking = volume > 25; // ALWAYS sensitive

      document.querySelectorAll(".player").forEach(p => {
        p.classList.toggle("talking", talking);
      });

      requestAnimationFrame(loop);
    }

    loop();
  });
</script>

</body>
</html>
